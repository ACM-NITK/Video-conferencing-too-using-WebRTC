<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Video Chat Room</title>
    <style>
    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 300px);
      grid-auto-rows: 300px;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
    <div id="video-grid"></div>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script>
        var room_id = {{ room_id|safe }}
        const myPeer = new Peer(undefined, {
            host: '/',
            port: '3001'
        })
        var peers = [];
        myPeer.on('open',id=>{
            var x = '';
            for(var i=0;i<id.length;i++)
            {
                if(id[i]=='-')
                    x += '_';
                else
                    x += id[i];
            }
            var endpoint = 'ws://' + window.location.host + '/ws/' + room_id + '/' + x + '/'
            var socket = new WebSocket(endpoint)
            var myVideo = document.createElement('video')
            myVideo.muted = true
            navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true
            }).then(stream => {
                addVideoStream(myVideo, stream)
                myPeer.on('call',call => {
                    call.answer(stream)
                    var video = document.createElement('video')
                    call.on('stream',rec_stream => {
                        addVideoStream(video,rec_stream)
                    })
                })
                socket.onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    var y = data.obj.id;
                    var rec_id = '';
                    console.log(y.length)
                    for(var i=0;i<y.length;i++)
                    {
                      if(y[i]=='_')
                          rec_id += '-';
                      else
                          rec_id += y[i];
                    }
                    console.log(rec_id);
                    if(data.obj.type === 1)
                        ConnectToUser(stream,rec_id);
                    else
                        peers[rec_id].close();
                };
            })
        })
        function addVideoStream(video, stream)
        {
            video.srcObject = stream
            video.addEventListener('loadedmetadata', () => {
            video.play()
            })
            var videoGrid = document.getElementById('video-grid')
            videoGrid.append(video)
        }
        function ConnectToUser(stream,rec_id)
        {
            var call = myPeer.call(rec_id,stream)
            var video = document.createElement('video')
            call.on('stream',rec_stream => {
                addVideoStream(video,rec_stream)
            })
            call.on('close',() => {
                video.remove()
            })
            peers[rec_id] = call;
        }
    </script>
</body>
</html>
