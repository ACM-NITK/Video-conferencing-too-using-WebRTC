<div id="video-grid"></div>
<style>
    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 300px);
      grid-auto-rows: 300px;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
</style>
<script>
	var targetUsername = null
	var hasstarted = false
	var alreadyrecieved = []
	var conntetedpeers = {}
	var room_id = "{{ room_id|safe }}"
	var user_name = "{{ user_name|safe }}"
	var endpoint = 'wss://' + window.location.host + '/ws/' + room_id + '/' + user_name + '/'
	socket = new WebSocket(endpoint)
	var mediaConstraints = {
		audio: false, 
		video: true 
	};
	socket.onmessage = function(e) {
		var data = JSON.parse(e.data).obj
		// console.log(data)
		if(data.type === "joined")
			invite(data)
		else if(data.type === "video-offer" && data.target=== user_name)
			handleVideoOfferMsg(data)
		else if(data.type === "new-ice-candidate" && data.target === user_name)
			handleNewICECandidateMsg(data)
		else  if(data.type === "video-answer" && data.target === user_name)
			handleAnswerMsg(data)
		else if(data.type === "left")
			handleLeftMsg(data)
	}
	async function invite(data)
	{
		targetUsername = data.name;
    	createPeerConnection(targetUsername);
		myPeerConnection = conntetedpeers[targetUsername][0]
		localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints)
		localStream.getTracks().forEach(track => myPeerConnection.addTrack(track, localStream));
	}
	function createPeerConnection(targetUsername)
	{
		myPeerConnection = new RTCPeerConnection({
			iceServers: [
				{
				urls: "stun:stun.l.google.com:19302"
				}
			]
  		});
		myPeerConnection.onicecandidate = tmpIcefunc = e => handleICECandidateEvent(e,targetUsername);
		myPeerConnection.onnegotiationneeded = tmpfunc = e => handleNegotiationNeededEvent(e,targetUsername);
		myPeerConnection.ontrack = tmpStreamfunc = e => handleRemoteStreamEvent(e,targetUsername);
		conntetedpeers[targetUsername] = [myPeerConnection,[]]
		myPeerConnection = null
	}
	async function handleNegotiationNeededEvent(event,targetUsername) 
	{
		if(targetUsername in alreadyrecieved)
			return
		localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints)
		if(!hasstarted)
			addVideoStream(localStream,user_name)
		hasstarted = true;
		myPeerConnection = conntetedpeers[targetUsername][0]
		await myPeerConnection.createOffer()
		await myPeerConnection.setLocalDescription();
		socket.send(JSON.stringify({
			"name": user_name,
			"target": targetUsername,
			"type": "video-offer",
			"sdp": myPeerConnection.localDescription
		}))
	}
	async function handleAnswerMsg(msg)
	{
		var desc = new RTCSessionDescription(msg.sdp)
		console.log(msg)
		myPeerConnection = conntetedpeers[msg.name][0]
		if(!!!desc)
			return
		await myPeerConnection.setRemoteDescription(desc)
		candidates = conntetedpeers[msg.name][1]
		candidates.forEach(candidate => myPeerConnection.addIceCandidate(candidate))
	} 
	async function handleVideoOfferMsg(msg) 
	{
		var localStream = null;
		targetUsername = msg.name;
		alreadyrecieved = [...alreadyrecieved,msg.name]
		var desc = new RTCSessionDescription(msg.sdp);
		createPeerConnection(targetUsername);
		myPeerConnection = conntetedpeers[msg.name][0]
		await myPeerConnection.setRemoteDescription(desc)
		candidates = conntetedpeers[msg.name][1]
		candidates.forEach(candidate => myPeerConnection.addIceCandidate(candidate))
		stream = await navigator.mediaDevices.getUserMedia(mediaConstraints)
		localStream = stream;
		if(!hasstarted)
			addVideoStream(localStream,user_name)
		hasstarted = true;
		await localStream.getTracks().forEach(track => myPeerConnection.addTrack(track, localStream));
		myPeerConnection = conntetedpeers[msg.name][0]
		answer = await myPeerConnection.createAnswer();
		await myPeerConnection.setLocalDescription();
		socket.send(JSON.stringify({
			"name": user_name,
			"target": targetUsername,
			"type": "video-answer",
			"sdp": myPeerConnection.localDescription
		}))
	}
	function handleICECandidateEvent(event,targetUsername) 
	{
		if (event.candidate) 
		{
			socket.send(JSON.stringify({
				"type": "new-ice-candidate",
				"target": targetUsername,
				"name": user_name,
				"candidate": event.candidate
            }))
		}
	}
	function handleNewICECandidateMsg(msg) 
	{
		var candidate = new RTCIceCandidate(msg.candidate);
		candidates = conntetedpeers[msg.name][1]
		myPeerConnection = conntetedpeers[msg.name][0]
		if(!myPeerConnection || !myPeerConnection.remoteDescription)
			candidates.push(candidate)
		else
			myPeerConnection.addIceCandidate(candidate)
	}
	function handleRemoteStreamEvent(event,user_id)
	{
		addVideoStream(event.streams[0],user_id)
	}
	function handleLeftMsg(msg)
	{
		document.getElementById(msg.name).remove()
	}
	function addVideoStream(stream,user_id) 
	{
		const video = document.createElement('video')
		video.id = user_id
		const videoGrid = document.getElementById('video-grid')
		video.srcObject = stream
		video.addEventListener('loadedmetadata', () => {
			video.play()
		})
		videoGrid.append(video)
	}
</script>